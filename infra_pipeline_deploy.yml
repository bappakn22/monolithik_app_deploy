name: infra_deploy

trigger: none

variables:
  - name: WORK_DIR
    value: '$(System.DefaultWorkingDirectory)/environment'
  - name: SER_CONN
    value: 'Empire_Operations_Agent_SC'
    

parameters:
  - name: infraenv
    displayName: environment
    type: string
    default: preprod
    values:
      - preprod
      - prod

pool: 
 name: Empire_Operations_Agent


stages:
 - stage: terraforminit
   jobs:
     - job: terraforminit
       steps:
        - task: TerraformTask@5
          displayName: terraform init
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: $(WORK_DIR)/${{ parameters.infraenv }}
            backendServiceArm: $(SER_CONN)
            backendAzureRmOverrideSubscriptionID: 'b4461466-1e6b-4be2-bb70-1e96a72a41c8'
            backendAzureRmResourceGroupName: 'Empire_Operation_rg'
            backendAzureRmStorageAccountName: 'empireoperationstg'
            backendAzureRmContainerName: 'empirecontainer'
            backendAzureRmKey: 'infradev.tfstate'

        - task: TerraformTask@5
          displayName: validation
          inputs:
            provider: 'azurerm'
            command: 'validate'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

        - task: DownloadSecureFile@1
          displayName: tfvars download
          name: tfvars
          inputs:
            secureFile: 'terraform-${{ parameters.infraenv }}.tfvars'

        
        - task: PowerShell@2
          inputs:
            targetType: 'inline'
            script: cp "$(tfvars.secureFilePath)" "$(WORK_DIR)/${{ parameters.infraenv }}"

